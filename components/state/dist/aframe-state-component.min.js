!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var n in i)("object"==typeof exports?exports:t)[n]=i[n]}}("undefined"!=typeof self?self:this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var s=i[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,e),s.l=!0,s.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,n){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,i){"use strict";function n(t,e,i,n){var r,a,o,d,h,c;if(c=l(e,/\s+/),1===c.length)return s(t,e,i,n);for(v.length=0,u(m,c),o=0;o<m.length;o++)-1!==y.indexOf(m[o])?(a=s(t,v.pop()),h=m[o+1].replace(p,""),a=void 0===a?void 0:a.toString(),h=void 0===h?void 0:h.toString(),r=-1===m[o].indexOf("!")?a===h:a!==h,v.push(r),o++):v.push(m[o]);if(1===v.length)return v[0];for(d=v[0].constructor===Boolean?v[0]:s(t,v[0],i,n),o=1;o<v.length;o+=2)v[o]!==b&&v[o]!==f||(v[o+1]=v[o+1].constructor===Boolean?v[o+1]:s(t,v[o+1]),v[o]===b?d=d||v[o+1]:v[o]===f&&(d=d&&v[o+1]));return d}function s(t,e,i,n){var r,a,o,d;for(i&&e.startsWith(i.for)&&(a=e,e=i.in),d=t,o=l(c(e),"."),r=0;r<o.length;r++)r<o.length-1&&!(o[r]in d)&&console.error("[state] Not found:",o,o[r]),d=d[o[r]];if(i&&a.startsWith(i.for)){if(!i.key)return d[n];for(r=0;r<d.length;r++)if(d[r][i.key]===n){d=s(d[r],a.replace(i.for+".",""));break}}return"!"===e[0]&&"!"===e[1]?!!d:"!"===e[0]?!d:d}function r(t){for(var e in t)delete t[e]}function a(){var t,e,i,n=arguments;for(i={},e=0;e<n.length;e++)for(t in n[e])t in i?i[t].constructor===Array?i[t].push(n[e][t]):i[t]=[i[t],n[e][t]]:i[t]=n[e][t];for(t in i)i[t].constructor===Array&&(i[t]=o.apply(this,i[t]));return i}function o(){var t=arguments;return function(){var e;for(e=0;e<t.length;e++)t[e].apply(this,arguments)}}function d(t,e){var i,n;for(n=e.split(/\s+/),i=0;i<n.length;i++)-1!==g.indexOf(n[i])||n[i].startsWith("'")||-1!==t.indexOf(n[i])||t.push(h(n[i]))}function h(t){var e;return t=c(t.trim()),e=t.indexOf("."),-1===e?t:t.substring(0,t.indexOf("."))}function c(t){return 0===t.indexOf("!!")?t.replace("!!",""):0===t.indexOf("!")?t.replace("!",""):t}function l(t,e){return A[e]||(A[e]={}),A[e][t]?A[e][t]:(A[e][t]=t.split(e),A[e][t])}function u(t,e){var i;for(t.length=0,i=0;i<e.length;i++)t[i]=e[i]}var f="&&",p=/'/g,b="||",y=["==","===","!=","!=="],m=[],v=[];t.exports.select=n,t.exports.selectProperty=s,t.exports.clearObject=r,t.exports.composeHandlers=a,t.exports.composeFunctions=o;var g=["||","&&","!=","!==","==","==="];t.exports.parseKeysToWatch=d;var A={};t.exports.split=l,t.exports.copyArray=u},function(t,e,i){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i(2);var s=i(3),r=i(0),a=i(4).wrapArray,o={initialState:{},nonBindedStateKeys:[],handlers:{},computeState:function(){}};AFRAME.registerState=function(t){AFRAME.utils.extend(o,t)},AFRAME.registerSystem("state",{init:function(){var t,e=this;this.diff={},this.state=AFRAME.utils.clone(o.initialState),this.subscriptions=[],this.initEventHandlers();for(t in this.state)this.state[t]&&this.state[t].constructor===Array&&(this.state[t].__dirty=!0,a(this.state[t]));this.lastState=AFRAME.utils.clone(this.state),this.eventDetail={lastState:this.lastState,state:this.state},this.el.addEventListener("loaded",function(){var t;for(o.computeState(e.state,"@@INIT"),t=0;t<e.subscriptions.length;t++)e.subscriptions[t].onStateUpdate(e.state)})},dispatch:function(t,e){var i,n;console.log(t),o.handlers[t](this.state,e),o.computeState(this.state,t,e);for(n in this.diff)delete this.diff[n];for(s(this.lastState,this.state,this.diff,o.nonBindedStateKeys),i=0;i<this.subscriptions.length;i++){if("bind-for"===this.subscriptions[i].name){if(!this.state[this.subscriptions[i].keysToWatch[0]].__dirty)continue}else if(!this.shouldUpdate(this.subscriptions[i].keysToWatch,this.diff))continue;this.subscriptions[i].onStateUpdate()}for(n in this.state)this.state[n]&&this.state[n].constructor===Array&&(this.state[n].__dirty=!1);this.copyState(this.lastState,this.state),this.eventDetail.action=t,this.eventDetail.payload=e,this.el.emit("stateupdate",this.eventDetail)},copyState:function(t,e,i){var n;for(n in e)if(i||-1===o.nonBindedStateKeys.indexOf(n))if(e[n]&&e[n].constructor===Object){if(!(n in t)){t[n]=AFRAME.utils.clone(e[n]);continue}this.copyState(t[n],e[n],!0)}else t[n]=e[n]},subscribe:function(t){this.subscriptions.push(t)},unsubscribe:function(t){this.subscriptions.splice(this.subscriptions.indexOf(t),1)},shouldUpdate:function(t,e){var i;for(i in e)if(-1!==t.indexOf(i))return!0;return!1},initEventHandlers:function(){function t(t){var e=this;this.el.addEventListener(t,function(i){e.dispatch(t,i.detail)})}var e,i=[];t=t.bind(this);for(e in o.handlers)-1===i.indexOf(e)&&(i.push(e),t(e))},renderTemplate:function(){var t=/{{\s*(\w*\.)?([\w.]+)\s*}}/g;return function(e,i,s){var a,o;for(o=e;a=t.exec(e);)o=o.replace(a[0],"object"===(void 0===i?"undefined":n(i))?r.select(i,a[2])||"":i);return s?o:document.createRange().createContextualFragment(o)}}(),select:r.select}),AFRAME.registerComponent("bind",{schema:{default:{},parse:function(t){var e,i,n,s;if(t.constructor===Object)return t;if(-1===t.indexOf(":"))return t;for(e={},n=r.split(t,";"),i=0;i<n.length;i++)s=r.split(n[i].trim(),":"),e[s[0]]=s[1].trim();return e}},multiple:!0,init:function(){var t;this.data;this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system=this.el.sceneEl.systems.state,this.id&&(t=r.split(this.id,"__")[0]),this.isNamespacedBind=this.id&&t in AFRAME.components&&!AFRAME.components[t].isSingleProp||t in AFRAME.systems,this.lastData={},this.updateObj={},this.system.subscribe(this),this.onStateUpdate=this.onStateUpdate.bind(this)},update:function(){var t,e,i=this.data;if(this.keysToWatch.length=0,"string"==typeof i)r.parseKeysToWatch(this.keysToWatch,i);else for(e in i)r.parseKeysToWatch(this.keysToWatch,i[e]);t=this.el.closest("[bind-for]"),t&&t!==this.el?(this.bindForEl=t,this.bindRootEl=this.el.closest("[data-bind-for-key]"),this.bindFor=this.bindForEl.getAttribute("bind-for"),this.bindForKey=this.bindRootEl.getAttribute("data-bind-for-key"),this.keysToWatch.push(this.bindFor.in),this.bindForEl.addEventListener("bindforrender",this.onStateUpdate)):(this.bindFor="",this.bindForKey=""),this.onStateUpdate()},onStateUpdate:function(){var t,e,i,s,a,o=!1,d=this.el;if(d.parentNode){if(this.isNamespacedBind&&r.clearObject(this.updateObj),i=this.system.state,this.bindFor&&void 0!==this.bindForKey&&!this.bindFor.key){for(s=d;s.parentNode&&s.parentNode!==this.bindForEl;)s.parentNode&&(s=s.parentNode);this.bindForKey=parseInt(s.dataset.bindForKey,10)}if("object"!==n(this.data)){try{a=r.select(i,this.data,this.bindFor,this.bindForKey)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"!==(void 0===a?"undefined":n(a))&&"object"!==n(this.lastData)&&this.lastData===a)return;return AFRAME.utils.entity.setComponentProperty(d,this.id,a),void(this.lastData=a)}for(t in this.data){e=this.data[t].trim();try{if(a=r.select(i,e,this.bindFor,this.bindForKey),this.bindFor&&void 0===a)return}catch(t){throw new Error("[aframe-state-component] Key '"+e+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}if("object"===(void 0===a?"undefined":n(a))||"object"===n(this.lastData[t])||this.lastData[t]!==a){if(t in AFRAME.components&&void 0===a)return void d.removeAttribute(t);this.isNamespacedBind?this.updateObj[t]=a:AFRAME.utils.entity.setComponentProperty(d,t,a),this.lastData[t]=a}}for(o in this.updateObj);this.isNamespacedBind&&o&&d.setAttribute(this.id,this.updateObj)}},remove:function(){this.system.unsubscribe(this),this.bindForEl&&this.bindForEl.removeEventListener("bindforrender",this.onStateUpdate)}}),AFRAME.registerComponent("bind-toggle",{schema:{type:"string"},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.state,this.keysToWatch=[],this.onStateUpdate=this.onStateUpdate.bind(this),this.system.subscribe(this),this.onStateUpdate()},update:function(){this.keysToWatch.length=0,r.parseKeysToWatch(this.keysToWatch,this.data)},onStateUpdate:function(){var t,e,i=this.el;t=this.system.state;try{e=r.select(t,this.data)}catch(t){throw new Error("[aframe-state-component] Key '"+this.data+"' not found in state. #"+this.el.getAttribute("id")+"["+this.attrName+"]")}e?i.setAttribute(this.id,""):i.removeAttribute(this.id)},remove:function(){this.system.unsubscribe(this)}}),t.exports={composeFunctions:r.composeFunctions,composeHandlers:r.composeHandlers,select:r.select}},function(t,e,i){"use strict";var n=i(0);AFRAME.registerComponent("bind-for",{schema:{for:{type:"string",default:"item"},in:{type:"string"},key:{type:"string"},template:{type:"string"},updateInPlace:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.state,this.onStateUpdate=this.onStateUpdate.bind(this),this.keysToWatch=[],this.renderedKeys=[],this.system.subscribe(this)},update:function(){this.keysToWatch[0]=n.split(this.data.in,".")[0],this.el.children[0]&&"TEMPLATE"===this.el.children[0].tagName?this.template=this.el.children[0].innerHTML.trim():this.template=document.querySelector(this.data.template).innerHTML.trim(),this.onStateUpdate()},onStateUpdateNaive:function(){var t=[];return function(){var e,i,s,r,a=this.data,o=this.el;try{s=n.select(this.system.state,a.in)}catch(t){throw new Error("[aframe-state-component] Key '"+a.in+"' not found in state. #"+o.getAttribute("id")+"["+this.attrName+"]")}for(t.length=0,i=0;i<s.length;i++){var d=s[i];r=a.key?d[a.key].toString():d.toString(),t.push(r),-1===this.renderedKeys.indexOf(r)&&(o.appendChild(this.generateFromTemplate(d,i)),this.renderedKeys.push(r))}var h=this.getElsToRemove(t,this.renderedKeys);for(i=0;i<h.length;i++)h[i].parentNode.removeChild(h[i]);if(s.length&&s[0].constructor===String)for(i=0;i<s.length;i++)(e=o.querySelector('[data-bind-for-value="'+s[i]+'"]'))&&e.setAttribute("data-bind-for-key",i.toString());this.el.emit("bindforrender",null,!1)}}(),onStateUpdateInPlace:function(){var t=[];return function(){var e,i,s,r,a=this,o=this.data,d=this.el;try{s=n.select(this.system.state,o.in)}catch(t){throw new Error("[aframe-state-component] Key '"+o.in+"' not found in state. #"+d.getAttribute("id")+"["+this.attrName+"]")}for(t.length=0,i=0;i<s.length;i++){var h=s[i];r=o.key?h[o.key].toString():h.toString(),t.push(r)}for(var c=this.getElsToRemove(t,this.renderedKeys),l=0;l<c.length;l++)c[l].object3D.visible=!1,c[l].setAttribute("data-bind-for-active","false"),c[l].removeAttribute("data-bind-for-key"),c[l].removeAttribute("data-bind-for-value"),c[l].emit("bindfordeactivate",null,!1),c[l].pause();for(i=0;i<s.length;i++)!function(){var e=s[i],n=a.getBindForKey(e,i);if(r=o.key?e[o.key].toString():e.toString(),-1===a.renderedKeys.indexOf(r)){if(d.querySelector(':scope > [data-bind-for-active="false"]')){var h=d.querySelector('[data-bind-for-active="false"]');h.setAttribute("data-bind-for-key",n),h.setAttribute("data-bind-for-value",r),h.object3D.visible=!0,h.play(),h.setAttribute("data-bind-for-active","true"),h.emit("bindforupdateinplace",e,!1)}else{var c=a.generateFromTemplate(e,i);c.addEventListener("loaded",function(){c.emit("bindforupdateinplace",e,!1)}),d.appendChild(c)}a.renderedKeys.push(r)}else-1!==t.indexOf(n)&&a.el.querySelector('[data-bind-for-key="'+n+'"]').emit("bindforupdateinplace",e,!1)}();if(s.length&&s[0].constructor===String)for(i=0;i<s.length;i++)(e=d.querySelector('[data-bind-for-value="'+s[i]+'"]'))&&e.setAttribute("data-bind-for-key",i.toString());this.el.emit("bindforrender",null,!1)}}(),generateFromTemplate:function(t,e){var i=this.data;this.el.appendChild(this.system.renderTemplate(this.template,t));var n=this.el.children[this.el.children.length-1],s=this.getBindForKey(t,e);return n.setAttribute("data-bind-for-key",s),i.key||n.setAttribute("data-bind-for-value",t),n.setAttribute("data-bind-for-active","true"),n},getElsToRemove:function(){var t=[];return function(e,i){var n=this.data,s=this.el;t.length=0;for(var r=0;r<s.children.length;r++)if("TEMPLATE"!==s.children[r].tagName){var a=n.key?s.children[r].getAttribute("data-bind-for-key"):s.children[r].getAttribute("data-bind-for-value");-1===e.indexOf(a)&&(t.push(s.children[r]),i.splice(i.indexOf(a),1))}return t}}(),getBindForKey:function(t,e){return this.data.key?t[this.data.key].toString():e.toString()},onStateUpdate:function(){this.data.updateInPlace?this.onStateUpdateInPlace():this.onStateUpdateNaive()}}),AFRAME.registerComponent("bind-item",{schema:{type:"string"},multiple:!0,init:function(){this.prevValues={};var t=this.rootEl=this.el.closest("[data-bind-for-key]");if(!t)throw new Error("bind-item component must be attached to entity under a bind-for item.");t.addEventListener("bindforupdateinplace",this.updateInPlace.bind(this)),t.addEventListener("bindfordeactivate",this.deactivate.bind(this)),this.bindForEl=this.el.closest("[bind-for]")},update:function(){this.parse()},updateInPlace:function(t){var e=this.propertyMap;for(var i in e){var n=this.select(t.detail,e[i]);n!==this.prevValues[i]&&(AFRAME.utils.entity.setComponentProperty(this.el,i,n),this.prevValues[i]=n)}},select:function(t,e){var i;if(-1!==e.indexOf("=")){var s=e.match(/item.(\w+)/);s&&(i=n.select(t,s[0].replace(/item./,"")),e=e.replace(/item.(\w+)/,"'"+i+"'")),i=n.select(this.el.sceneEl.systems.state.state,e)}else i="item"===e?t:n.select(t,e.replace(/item./,""));return i},deactivate:function(){this.prevValues={}},parse:function(){var t=this.propertyMap={};if(this.id in AFRAME.components&&!AFRAME.components[this.id].isSingleProp)for(var e=n.split(this.data,";"),i=0;i<e.length;i++){var s=n.split(e[i],":");t[this.id+"."+s[0].trim()]=s[1].trim()}else t[this.id]=this.data}})},function(t,e,i){"use strict";t.exports=function(){var t=[];return function(e,i,n,s){var r,a,o,d,h,c,l;d=n||{},t.length=0;for(h in e)t.push(h);if(!i)return d;for(o in i)-1===t.indexOf(o)&&t.push(o);for(c=0;c<t.length;c++)h=t[c],s&&-1!==s.indexOf(h)||(r=e[h],a=i[h],((l=r&&a&&r.constructor===Object&&a.constructor===Object)&&!AFRAME.utils.deepEqual(r,a)||!l&&r!==a)&&(d[h]=a));return d}}()},function(t,e,i){"use strict";function n(t){var e;if(!t.__wrapped){for(e=0;e<r.length;e++)s(t,r[e]);t.__wrapped=!0}}function s(t,e){var i=t[e];t[e]=function(){i.apply(t,arguments),t.__dirty=!0}}var r=["push","pop","shift","unshift","splice"];t.exports.wrapArray=n}])});