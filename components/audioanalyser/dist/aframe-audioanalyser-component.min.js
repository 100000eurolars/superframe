!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}("undefined"!=typeof self?self:this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var i={};AFRAME.registerComponent("audioanalyser",{schema:{buffer:{default:!1},beatDetectionDecay:{default:.99},beatDetectionMinVolume:{default:15},beatDetectionThrottle:{default:250},enabled:{default:!0},enableBeatDetection:{default:!0},enableLevels:{default:!0},enableWaveform:{default:!0},enableVolume:{default:!0},fftSize:{default:2048},smoothingTimeConstant:{default:.8},src:{parse:function(e){return e.constructor!==String?e:e.startsWith("#")||e.startsWith(".")?document.querySelector(e):e}},unique:{default:!1}},init:function(){var e,t,n=this.data;this.audioEl=null,this.context=new AudioContext,this.levels=null,this.waveform=null,this.volume=0,e=this.analyser=this.context.createAnalyser(),t=this.gainNode=this.context.createGain(),t.connect(e),e.connect(this.context.destination),e.fftSize=n.fftSize,e.smoothingTimeConstant=n.smoothingTimeConstant,this.levels=new Uint8Array(e.frequencyBinCount),this.waveform=new Uint8Array(e.fftSize)},update:function(e){var t=this.analyser,n=this.data;e.fftSize===n.fftSize&&e.smoothingTimeConstant===n.smoothingTimeConstant||(t.fftSize=n.fftSize,t.smoothingTimeConstant=n.smoothingTimeConstant,this.levels=new Uint8Array(t.frequencyBinCount),this.waveform=new Uint8Array(t.fftSize)),n.src&&this.refreshSource()},tick:function(e,t){var n,i=this.data;if(i.enabled){if((i.enableLevels||i.enableVolume)&&this.analyser.getByteFrequencyData(this.levels),i.enableWaveform&&this.analyser.getByteTimeDomainData(this.waveform),i.enableVolume||i.enableBeatDetection){for(var o=0,a=0;a<this.levels.length;a++)o+=this.levels[a];this.volume=o/this.levels.length}i.enableBeatDetection&&(n=this.volume,this.beatCutOff||(this.beatCutOff=n),n>this.beatCutOff&&n>this.data.beatDetectionMinVolume?(console.log("[audioanalyser] Beat detected."),this.el.emit("audioanalyserbeat",null,!1),this.beatCutOff=1.5*n,this.beatTime=0):this.beatTime<=this.data.beatDetectionThrottle?this.beatTime+=t:(this.beatCutOff*=this.data.beatDetectionDecay,this.beatCutOff=Math.max(this.beatCutOff,this.data.beatDetectionMinVolume)))}},refreshSource:function(){var e=this,t=(this.analyser,this.data);t.buffer&&t.src.constructor===String?this.getBufferSource().then(function(t){e.source=t,e.source.connect(e.gainNode)}):(this.source=this.getMediaSource(),this.source.connect(this.gainNode))},suspendContext:function(){this.context.suspend()},resumeContext:function(){this.context.resume()},fetchAudioBuffer:function(e){var t=this;return new Promise(function(n){if(i[e])return n(i[e]);fetch(e).then(function(e){return e.arrayBuffer()}).then(function(o){t.context.decodeAudioData(o).then(function(t){i[e]=t,n(t)})}).catch(console.error)})},getBufferSource:function(){var e=this,t=this.data;return this.fetchAudioBuffer(t.src).then(function(){var n;return n=e.context.createBufferSource(),n.buffer=i[t.src],e.el.emit("audioanalyserbuffersource",n,!1),n}).catch(console.error)},getMediaSource:function(){return this.data.src.constructor===String?(this.audio||(this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous"),this.audio.setAttribute("src",this.data.src)):this.audio=this.data.src,this.context.createMediaElementSource(this.audio)}})}])});